"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _yamlJs = _interopRequireDefault(require("yaml-js"));

var _appiumSupport = require("appium-support");

var _validate = _interopRequireDefault(require("validate.js"));

var _handlebars = _interopRequireDefault(require("handlebars"));

var _replaceExt = _interopRequireDefault(require("replace-ext"));

var _lodash = _interopRequireDefault(require("lodash"));

var _asyncbox = require("asyncbox");

var _validator = require("./validator");

var _url = _interopRequireDefault(require("url"));

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _findRoot = _interopRequireDefault(require("find-root"));

const platformRanges = {
  xcuitest: ['9.3'],
  uiautomation: ['8.0', '9.3'],
  espresso: ['?'],
  uiautomator2: ['?'],
  uiautomator: ['4.2'],
  windows: ['10'],
  mac: ['?']
};
const appiumRanges = {
  xcuitest: ['1.6.0'],
  uiautomator2: ['1.6.0'],
  espresso: ['1.9.0'],
  windows: ['1.6.0'],
  mac: ['1.6.4']
};
const rootFolder = (0, _findRoot.default)(__dirname);

_handlebars.default.registerHelper('versions', function versionHelper(object, name, driverName) {
  if (!object) {
    return 'None';
  }

  if (!_lodash.default.isObject(object)) {
    object = {};
  }

  let min = object[name ? `${name}_min` : 'min'];
  let max = object[name ? `${name}_max` : 'max'];

  if (!min) {
    if (name === 'appium' && _lodash.default.isArray(appiumRanges[driverName])) {
      min = appiumRanges[driverName][0];
    } else if (name === 'platform' && _lodash.default.isArray(platformRanges[driverName])) {
      min = platformRanges[driverName][0];
    }
  }

  if (!max) {
    if (name === 'appium' && appiumRanges[driverName]) {
      max = appiumRanges[driverName][1];
    } else if (name === 'platform' && platformRanges[driverName]) {
      max = platformRanges[driverName][1];
    }
  }

  if (!min && !max) {
    return 'All';
  } else if (!max) {
    return `${min}+`;
  } else if (!min) {
    return `<= ${max}`;
  }

  return `${min} to ${max}`;
});

_handlebars.default.registerHelper('hyphenate', str => str.replace('_', '-'));

_handlebars.default.registerHelper('uppercase', str => str.toUpperCase());

_handlebars.default.registerHelper('capitalize', function capitalizeDriver(driverName) {
  switch (driverName.toLowerCase()) {
    case 'xcuitest':
      return 'XCUITest';

    case 'uiautomation':
      return 'UIAutomation';

    case 'uiautomator2':
      return 'UiAutomator2';

    case 'uiautomator':
      return 'UiAutomator';

    case 'espresso':
      return 'Espresso';

    default:
      return driverName.length === 0 ? driverName : driverName[0].toUpperCase() + driverName.substr(1);
  }
});

_handlebars.default.registerHelper('if_eq', function ifEq(a, b, opts) {
  if (a === b) {
    return opts.fn(this);
  } else {
    return opts.inverse(this);
  }
});

function getBaseHostname(fullUrl) {
  const baseUrl = _url.default.parse(fullUrl);

  return baseUrl.hostname;
}

_handlebars.default.registerHelper('base_url', function baseUrl(fullUrl) {
  return getBaseHostname(fullUrl);
});

_handlebars.default.registerHelper('client_url', function clientUrl(clientUrl) {
  if (!clientUrl) {
    return;
  }

  const createUrlString = function createUrlString(clientUrl, name = getBaseHostname(clientUrl)) {
    return `[${name}](${clientUrl})`;
  };

  if (!_lodash.default.isArray(clientUrl)) {
    return createUrlString(clientUrl);
  }

  let urlStrings = [];

  for (const item of clientUrl) {
    for (let [key, value] of _lodash.default.toPairs(item)) {
      key = key.toLowerCase();
      const urlStr = _validator.CLIENT_URL_TYPES[key] === 'hostname' ? createUrlString(value) : createUrlString(value, _validator.CLIENT_URL_TYPES[key]);
      urlStrings.push(urlStr);
    }
  }

  return urlStrings.join(' ');
});

async function registerSpecUrlHelper() {
  const routesFile = await _appiumSupport.fs.readFile(_path.default.resolve(rootFolder, 'node_modules', 'appium-base-driver', 'lib', 'protocol', 'routes.js'), 'utf8');
  const routesFileLines = routesFile.split('\n');

  _handlebars.default.registerHelper('spec_url', function specUrl(specUrl, endpoint) {
    if (!specUrl.includes('routes.js')) {
      return specUrl;
    }

    if (specUrl.startsWith('routes.js')) {
      specUrl = `https://github.com/appium/appium-base-driver/blob/master/lib/protocol/${specUrl}`;
    }

    specUrl = specUrl.split('#L')[0];
    endpoint = endpoint.replace('session_id', 'sessionId');
    endpoint = endpoint.replace('element_id', 'elementId');
    let index;

    for (const i in routesFileLines) {
      if (routesFileLines[i].includes(endpoint)) {
        index = parseInt(i, 10) + 1;
        break;
      }
    }

    if (_lodash.default.isUndefined(index)) {
      throw new Error(`Unable to find entry in 'appium-base-driver#routes' for endpoint '${endpoint}'`);
    }

    return `${specUrl}#L${index}`;
  });
}

async function generateCommands() {
  await registerSpecUrlHelper();

  const commands = _path.default.resolve(rootFolder, 'commands-yml', 'commands/**/*.yml');

  (0, _fancyLog.default)('Traversing YML files', commands);
  await _appiumSupport.fs.rimraf(_path.default.resolve(rootFolder, 'docs', 'en', 'commands'));

  const template = _handlebars.default.compile((await _appiumSupport.fs.readFile(_path.default.resolve(rootFolder, 'commands-yml', 'template.md'), 'utf8')), {
    noEscape: true,
    strict: true
  });

  let fileCount = 0;

  for (const filename of await _appiumSupport.fs.glob(commands)) {
    const relativeFilename = _path.default.relative(_path.default.resolve(rootFolder, 'commands-yml'), filename);

    (0, _fancyLog.default)(`Rendering file: ${filename} ${relativeFilename}`);
    const inputYML = await _appiumSupport.fs.readFile(filename, 'utf8');

    const inputJSON = _yamlJs.default.load(inputYML);

    inputJSON.ymlFileName = `/${_path.default.relative(rootFolder, filename)}`;
    const validationErrors = (0, _validate.default)(inputJSON, _validator.validator);

    if (validationErrors) {
      throw new Error(`Data validation error for ${filename}: ${JSON.stringify(validationErrors)}`);
    }

    const markdown = template(inputJSON);
    const markdownPath = (0, _replaceExt.default)(relativeFilename, '.md');

    const outfile = _path.default.resolve(rootFolder, 'docs', 'en', markdownPath);

    (0, _fancyLog.default)(`    Writing to: ${outfile}`);
    await (0, _appiumSupport.mkdirp)(_path.default.dirname(outfile));
    await _appiumSupport.fs.writeFile(outfile, markdown, 'utf8');
    fileCount++;
  }

  (0, _fancyLog.default)(`Done writing ${fileCount} command documents`);
}

async function generateCommandIndex() {
  function getTree(element, path) {
    let node = {
      name: element[0]
    };

    if (!_lodash.default.isArray(element[1])) {
      node.path = `${path}/${element[1]}`;
    } else {
      node.path = `${path}/${element[1][0]}`;
      const name = element[1].shift();
      node.commands = [];

      for (let subElement of element[1]) {
        node.commands.push(getTree(subElement, `${path}/${name}`));
      }
    }

    return node;
  }

  const toc = require(_path.default.resolve(rootFolder, 'docs', 'toc.js'));

  const commandToc = _lodash.default.find(toc.en, value => value.indexOf('Commands') === 0);

  const commands = [];

  for (let el of commandToc[1].slice(1)) {
    commands.push(getTree(el, '/docs/en/commands'));
  }

  const commandTemplate = _handlebars.default.compile((await _appiumSupport.fs.readFile(_path.default.resolve(rootFolder, 'commands-yml', 'api-template.md'), 'utf8')), {
    noEscape: true,
    strict: true
  });

  async function writeIndex(index, commands, indexPath) {
    (0, _fancyLog.default)(`Creating API index '${index}'`);
    const commandMarkdown = commandTemplate({
      commands,
      path: indexPath
    });
    await _appiumSupport.fs.writeFile(index, commandMarkdown, 'utf8');
  }

  const apiIndex = _path.default.resolve(rootFolder, 'docs', 'en', 'about-appium', 'api.md');

  await writeIndex(apiIndex, commands);
  (0, _fancyLog.default)(`Done writing main API index`);

  async function writeIndividualIndexes(command) {
    if (!_appiumSupport.util.hasValue(command.commands)) {
      return;
    }

    const relPath = command.path.startsWith(_path.default.sep) ? command.path.substring(1) : command.path;

    const index = _path.default.resolve(rootFolder, relPath, 'README.md');

    await writeIndex(index, command.commands, command.path);

    for (const el of command.commands) {
      await writeIndividualIndexes(el);
    }
  }

  const index = _path.default.resolve(rootFolder, 'docs', 'en', 'commands', 'README.md');

  await writeIndex(index, commands);

  for (const el of commands) {
    await writeIndividualIndexes(el);
  }
}

async function main() {
  await generateCommands();
  await generateCommandIndex();
}

(0, _asyncbox.asyncify)(main);require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbW1hbmRzLXltbC9wYXJzZS5qcyJdLCJuYW1lcyI6WyJwbGF0Zm9ybVJhbmdlcyIsInhjdWl0ZXN0IiwidWlhdXRvbWF0aW9uIiwiZXNwcmVzc28iLCJ1aWF1dG9tYXRvcjIiLCJ1aWF1dG9tYXRvciIsIndpbmRvd3MiLCJtYWMiLCJhcHBpdW1SYW5nZXMiLCJyb290Rm9sZGVyIiwiX19kaXJuYW1lIiwiSGFuZGxlYmFycyIsInJlZ2lzdGVySGVscGVyIiwidmVyc2lvbkhlbHBlciIsIm9iamVjdCIsIm5hbWUiLCJkcml2ZXJOYW1lIiwiXyIsImlzT2JqZWN0IiwibWluIiwibWF4IiwiaXNBcnJheSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsImNhcGl0YWxpemVEcml2ZXIiLCJ0b0xvd2VyQ2FzZSIsImxlbmd0aCIsInN1YnN0ciIsImlmRXEiLCJhIiwiYiIsIm9wdHMiLCJmbiIsImludmVyc2UiLCJnZXRCYXNlSG9zdG5hbWUiLCJmdWxsVXJsIiwiYmFzZVVybCIsInVybCIsInBhcnNlIiwiaG9zdG5hbWUiLCJjbGllbnRVcmwiLCJjcmVhdGVVcmxTdHJpbmciLCJ1cmxTdHJpbmdzIiwiaXRlbSIsImtleSIsInZhbHVlIiwidG9QYWlycyIsInVybFN0ciIsIkNMSUVOVF9VUkxfVFlQRVMiLCJwdXNoIiwiam9pbiIsInJlZ2lzdGVyU3BlY1VybEhlbHBlciIsInJvdXRlc0ZpbGUiLCJmcyIsInJlYWRGaWxlIiwicGF0aCIsInJlc29sdmUiLCJyb3V0ZXNGaWxlTGluZXMiLCJzcGxpdCIsInNwZWNVcmwiLCJlbmRwb2ludCIsImluY2x1ZGVzIiwic3RhcnRzV2l0aCIsImluZGV4IiwiaSIsInBhcnNlSW50IiwiaXNVbmRlZmluZWQiLCJFcnJvciIsImdlbmVyYXRlQ29tbWFuZHMiLCJjb21tYW5kcyIsInJpbXJhZiIsInRlbXBsYXRlIiwiY29tcGlsZSIsIm5vRXNjYXBlIiwic3RyaWN0IiwiZmlsZUNvdW50IiwiZmlsZW5hbWUiLCJnbG9iIiwicmVsYXRpdmVGaWxlbmFtZSIsInJlbGF0aXZlIiwiaW5wdXRZTUwiLCJpbnB1dEpTT04iLCJ5YW1sIiwibG9hZCIsInltbEZpbGVOYW1lIiwidmFsaWRhdGlvbkVycm9ycyIsInZhbGlkYXRvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJtYXJrZG93biIsIm1hcmtkb3duUGF0aCIsIm91dGZpbGUiLCJkaXJuYW1lIiwid3JpdGVGaWxlIiwiZ2VuZXJhdGVDb21tYW5kSW5kZXgiLCJnZXRUcmVlIiwiZWxlbWVudCIsIm5vZGUiLCJzaGlmdCIsInN1YkVsZW1lbnQiLCJ0b2MiLCJyZXF1aXJlIiwiY29tbWFuZFRvYyIsImZpbmQiLCJlbiIsImluZGV4T2YiLCJlbCIsInNsaWNlIiwiY29tbWFuZFRlbXBsYXRlIiwid3JpdGVJbmRleCIsImluZGV4UGF0aCIsImNvbW1hbmRNYXJrZG93biIsImFwaUluZGV4Iiwid3JpdGVJbmRpdmlkdWFsSW5kZXhlcyIsImNvbW1hbmQiLCJ1dGlsIiwiaGFzVmFsdWUiLCJyZWxQYXRoIiwic2VwIiwic3Vic3RyaW5nIiwibWFpbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUEsTUFBTUEsY0FBYyxHQUFHO0FBQ3JCQyxFQUFBQSxRQUFRLEVBQUUsQ0FBQyxLQUFELENBRFc7QUFFckJDLEVBQUFBLFlBQVksRUFBRSxDQUFDLEtBQUQsRUFBUSxLQUFSLENBRk87QUFHckJDLEVBQUFBLFFBQVEsRUFBRSxDQUFDLEdBQUQsQ0FIVztBQUlyQkMsRUFBQUEsWUFBWSxFQUFFLENBQUMsR0FBRCxDQUpPO0FBS3JCQyxFQUFBQSxXQUFXLEVBQUUsQ0FBQyxLQUFELENBTFE7QUFNckJDLEVBQUFBLE9BQU8sRUFBRSxDQUFDLElBQUQsQ0FOWTtBQU9yQkMsRUFBQUEsR0FBRyxFQUFFLENBQUMsR0FBRDtBQVBnQixDQUF2QjtBQVdBLE1BQU1DLFlBQVksR0FBRztBQUNuQlAsRUFBQUEsUUFBUSxFQUFFLENBQUMsT0FBRCxDQURTO0FBRW5CRyxFQUFBQSxZQUFZLEVBQUUsQ0FBQyxPQUFELENBRks7QUFHbkJELEVBQUFBLFFBQVEsRUFBRSxDQUFDLE9BQUQsQ0FIUztBQUluQkcsRUFBQUEsT0FBTyxFQUFFLENBQUMsT0FBRCxDQUpVO0FBS25CQyxFQUFBQSxHQUFHLEVBQUUsQ0FBQyxPQUFEO0FBTGMsQ0FBckI7QUFRQSxNQUFNRSxVQUFVLEdBQUcsdUJBQVNDLFNBQVQsQ0FBbkI7O0FBR0FDLG9CQUFXQyxjQUFYLENBQTBCLFVBQTFCLEVBQXNDLFNBQVNDLGFBQVQsQ0FBd0JDLE1BQXhCLEVBQWdDQyxJQUFoQyxFQUFzQ0MsVUFBdEMsRUFBa0Q7QUFDdEYsTUFBSSxDQUFDRixNQUFMLEVBQWE7QUFDWCxXQUFPLE1BQVA7QUFDRDs7QUFFRCxNQUFJLENBQUNHLGdCQUFFQyxRQUFGLENBQVdKLE1BQVgsQ0FBTCxFQUF5QjtBQUN2QkEsSUFBQUEsTUFBTSxHQUFHLEVBQVQ7QUFDRDs7QUFFRCxNQUFJSyxHQUFHLEdBQUdMLE1BQU0sQ0FBQ0MsSUFBSSxHQUFJLEdBQUVBLElBQUssTUFBWCxHQUFtQixLQUF4QixDQUFoQjtBQUNBLE1BQUlLLEdBQUcsR0FBR04sTUFBTSxDQUFDQyxJQUFJLEdBQUksR0FBRUEsSUFBSyxNQUFYLEdBQW1CLEtBQXhCLENBQWhCOztBQUVBLE1BQUksQ0FBQ0ksR0FBTCxFQUFVO0FBQ1IsUUFBSUosSUFBSSxLQUFLLFFBQVQsSUFBcUJFLGdCQUFFSSxPQUFGLENBQVViLFlBQVksQ0FBQ1EsVUFBRCxDQUF0QixDQUF6QixFQUE4RDtBQUM1REcsTUFBQUEsR0FBRyxHQUFHWCxZQUFZLENBQUNRLFVBQUQsQ0FBWixDQUF5QixDQUF6QixDQUFOO0FBQ0QsS0FGRCxNQUVPLElBQUlELElBQUksS0FBSyxVQUFULElBQXVCRSxnQkFBRUksT0FBRixDQUFVckIsY0FBYyxDQUFDZ0IsVUFBRCxDQUF4QixDQUEzQixFQUFrRTtBQUN2RUcsTUFBQUEsR0FBRyxHQUFHbkIsY0FBYyxDQUFDZ0IsVUFBRCxDQUFkLENBQTJCLENBQTNCLENBQU47QUFDRDtBQUNGOztBQUVELE1BQUksQ0FBQ0ksR0FBTCxFQUFVO0FBQ1IsUUFBSUwsSUFBSSxLQUFLLFFBQVQsSUFBcUJQLFlBQVksQ0FBQ1EsVUFBRCxDQUFyQyxFQUFtRDtBQUNqREksTUFBQUEsR0FBRyxHQUFHWixZQUFZLENBQUNRLFVBQUQsQ0FBWixDQUF5QixDQUF6QixDQUFOO0FBQ0QsS0FGRCxNQUVPLElBQUlELElBQUksS0FBSyxVQUFULElBQXVCZixjQUFjLENBQUNnQixVQUFELENBQXpDLEVBQXVEO0FBQzVESSxNQUFBQSxHQUFHLEdBQUdwQixjQUFjLENBQUNnQixVQUFELENBQWQsQ0FBMkIsQ0FBM0IsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSSxDQUFDRyxHQUFELElBQVEsQ0FBQ0MsR0FBYixFQUFrQjtBQUNoQixXQUFPLEtBQVA7QUFDRCxHQUZELE1BRU8sSUFBSSxDQUFDQSxHQUFMLEVBQVU7QUFDZixXQUFRLEdBQUVELEdBQUksR0FBZDtBQUNELEdBRk0sTUFFQSxJQUFJLENBQUNBLEdBQUwsRUFBVTtBQUNmLFdBQVEsTUFBS0MsR0FBSSxFQUFqQjtBQUNEOztBQUVELFNBQVEsR0FBRUQsR0FBSSxPQUFNQyxHQUFJLEVBQXhCO0FBQ0QsQ0FyQ0Q7O0FBdUNBVCxvQkFBV0MsY0FBWCxDQUEwQixXQUExQixFQUF3Q1UsR0FBRCxJQUFTQSxHQUFHLENBQUNDLE9BQUosQ0FBWSxHQUFaLEVBQWlCLEdBQWpCLENBQWhEOztBQUNBWixvQkFBV0MsY0FBWCxDQUEwQixXQUExQixFQUF3Q1UsR0FBRCxJQUFTQSxHQUFHLENBQUNFLFdBQUosRUFBaEQ7O0FBRUFiLG9CQUFXQyxjQUFYLENBQTBCLFlBQTFCLEVBQXdDLFNBQVNhLGdCQUFULENBQTJCVCxVQUEzQixFQUF1QztBQUM3RSxVQUFRQSxVQUFVLENBQUNVLFdBQVgsRUFBUjtBQUNFLFNBQUssVUFBTDtBQUNFLGFBQU8sVUFBUDs7QUFDRixTQUFLLGNBQUw7QUFDRSxhQUFPLGNBQVA7O0FBQ0YsU0FBSyxjQUFMO0FBQ0UsYUFBTyxjQUFQOztBQUNGLFNBQUssYUFBTDtBQUNFLGFBQU8sYUFBUDs7QUFDRixTQUFLLFVBQUw7QUFDRSxhQUFPLFVBQVA7O0FBQ0Y7QUFDRSxhQUFPVixVQUFVLENBQUNXLE1BQVgsS0FBc0IsQ0FBdEIsR0FBMEJYLFVBQTFCLEdBQXVDQSxVQUFVLENBQUMsQ0FBRCxDQUFWLENBQWNRLFdBQWQsS0FBOEJSLFVBQVUsQ0FBQ1ksTUFBWCxDQUFrQixDQUFsQixDQUE1RTtBQVpKO0FBY0QsQ0FmRDs7QUFpQkFqQixvQkFBV0MsY0FBWCxDQUEwQixPQUExQixFQUFtQyxTQUFTaUIsSUFBVCxDQUFlQyxDQUFmLEVBQWtCQyxDQUFsQixFQUFxQkMsSUFBckIsRUFBMkI7QUFDNUQsTUFBSUYsQ0FBQyxLQUFLQyxDQUFWLEVBQWE7QUFDWCxXQUFPQyxJQUFJLENBQUNDLEVBQUwsQ0FBUSxJQUFSLENBQVA7QUFDRCxHQUZELE1BRU87QUFDTCxXQUFPRCxJQUFJLENBQUNFLE9BQUwsQ0FBYSxJQUFiLENBQVA7QUFDRDtBQUNGLENBTkQ7O0FBUUEsU0FBU0MsZUFBVCxDQUEwQkMsT0FBMUIsRUFBbUM7QUFDakMsUUFBTUMsT0FBTyxHQUFHQyxhQUFJQyxLQUFKLENBQVVILE9BQVYsQ0FBaEI7O0FBQ0EsU0FBT0MsT0FBTyxDQUFDRyxRQUFmO0FBQ0Q7O0FBRUQ3QixvQkFBV0MsY0FBWCxDQUEwQixVQUExQixFQUFzQyxTQUFTeUIsT0FBVCxDQUFrQkQsT0FBbEIsRUFBMkI7QUFDL0QsU0FBT0QsZUFBZSxDQUFDQyxPQUFELENBQXRCO0FBQ0QsQ0FGRDs7QUFJQXpCLG9CQUFXQyxjQUFYLENBQTBCLFlBQTFCLEVBQXdDLFNBQVM2QixTQUFULENBQW9CQSxTQUFwQixFQUErQjtBQUNyRSxNQUFJLENBQUNBLFNBQUwsRUFBZ0I7QUFDZDtBQUNEOztBQUVELFFBQU1DLGVBQWUsR0FBRyxTQUFTQSxlQUFULENBQTBCRCxTQUExQixFQUFxQzFCLElBQUksR0FBR29CLGVBQWUsQ0FBQ00sU0FBRCxDQUEzRCxFQUF3RTtBQUM5RixXQUFRLElBQUcxQixJQUFLLEtBQUkwQixTQUFVLEdBQTlCO0FBQ0QsR0FGRDs7QUFJQSxNQUFJLENBQUN4QixnQkFBRUksT0FBRixDQUFVb0IsU0FBVixDQUFMLEVBQTJCO0FBQ3pCLFdBQU9DLGVBQWUsQ0FBQ0QsU0FBRCxDQUF0QjtBQUNEOztBQUVELE1BQUlFLFVBQVUsR0FBRyxFQUFqQjs7QUFDQSxPQUFLLE1BQU1DLElBQVgsSUFBbUJILFNBQW5CLEVBQThCO0FBQzVCLFNBQUssSUFBSSxDQUFDSSxHQUFELEVBQU1DLEtBQU4sQ0FBVCxJQUF5QjdCLGdCQUFFOEIsT0FBRixDQUFVSCxJQUFWLENBQXpCLEVBQTBDO0FBQ3hDQyxNQUFBQSxHQUFHLEdBQUdBLEdBQUcsQ0FBQ25CLFdBQUosRUFBTjtBQUNBLFlBQU1zQixNQUFNLEdBQUdDLDRCQUFpQkosR0FBakIsTUFBMEIsVUFBMUIsR0FDWEgsZUFBZSxDQUFDSSxLQUFELENBREosR0FFWEosZUFBZSxDQUFDSSxLQUFELEVBQVFHLDRCQUFpQkosR0FBakIsQ0FBUixDQUZuQjtBQUdBRixNQUFBQSxVQUFVLENBQUNPLElBQVgsQ0FBZ0JGLE1BQWhCO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPTCxVQUFVLENBQUNRLElBQVgsQ0FBZ0IsR0FBaEIsQ0FBUDtBQUNELENBeEJEOztBQTBCQSxlQUFlQyxxQkFBZixHQUF3QztBQUN0QyxRQUFNQyxVQUFVLEdBQUcsTUFBTUMsa0JBQUdDLFFBQUgsQ0FBWUMsY0FBS0MsT0FBTCxDQUFhaEQsVUFBYixFQUF5QixjQUF6QixFQUF5QyxvQkFBekMsRUFBK0QsS0FBL0QsRUFBc0UsVUFBdEUsRUFBa0YsV0FBbEYsQ0FBWixFQUE0RyxNQUE1RyxDQUF6QjtBQUNBLFFBQU1pRCxlQUFlLEdBQUdMLFVBQVUsQ0FBQ00sS0FBWCxDQUFpQixJQUFqQixDQUF4Qjs7QUFFQWhELHNCQUFXQyxjQUFYLENBQTBCLFVBQTFCLEVBQXNDLFNBQVNnRCxPQUFULENBQWtCQSxPQUFsQixFQUEyQkMsUUFBM0IsRUFBcUM7QUFFekUsUUFBSSxDQUFDRCxPQUFPLENBQUNFLFFBQVIsQ0FBaUIsV0FBakIsQ0FBTCxFQUFvQztBQUNsQyxhQUFPRixPQUFQO0FBQ0Q7O0FBRUQsUUFBSUEsT0FBTyxDQUFDRyxVQUFSLENBQW1CLFdBQW5CLENBQUosRUFBcUM7QUFDbkNILE1BQUFBLE9BQU8sR0FBSSx5RUFBd0VBLE9BQVEsRUFBM0Y7QUFDRDs7QUFHREEsSUFBQUEsT0FBTyxHQUFHQSxPQUFPLENBQUNELEtBQVIsQ0FBYyxJQUFkLEVBQW9CLENBQXBCLENBQVY7QUFHQUUsSUFBQUEsUUFBUSxHQUFHQSxRQUFRLENBQUN0QyxPQUFULENBQWlCLFlBQWpCLEVBQStCLFdBQS9CLENBQVg7QUFFQXNDLElBQUFBLFFBQVEsR0FBR0EsUUFBUSxDQUFDdEMsT0FBVCxDQUFpQixZQUFqQixFQUErQixXQUEvQixDQUFYO0FBR0EsUUFBSXlDLEtBQUo7O0FBQ0EsU0FBSyxNQUFNQyxDQUFYLElBQWdCUCxlQUFoQixFQUFpQztBQUMvQixVQUFJQSxlQUFlLENBQUNPLENBQUQsQ0FBZixDQUFtQkgsUUFBbkIsQ0FBNEJELFFBQTVCLENBQUosRUFBMkM7QUFFekNHLFFBQUFBLEtBQUssR0FBR0UsUUFBUSxDQUFDRCxDQUFELEVBQUksRUFBSixDQUFSLEdBQWtCLENBQTFCO0FBQ0E7QUFDRDtBQUNGOztBQUNELFFBQUloRCxnQkFBRWtELFdBQUYsQ0FBY0gsS0FBZCxDQUFKLEVBQTBCO0FBQ3hCLFlBQU0sSUFBSUksS0FBSixDQUFXLHFFQUFvRVAsUUFBUyxHQUF4RixDQUFOO0FBQ0Q7O0FBRUQsV0FBUSxHQUFFRCxPQUFRLEtBQUlJLEtBQU0sRUFBNUI7QUFDRCxHQWhDRDtBQWlDRDs7QUFFRCxlQUFlSyxnQkFBZixHQUFtQztBQUNqQyxRQUFNakIscUJBQXFCLEVBQTNCOztBQUVBLFFBQU1rQixRQUFRLEdBQUdkLGNBQUtDLE9BQUwsQ0FBYWhELFVBQWIsRUFBeUIsY0FBekIsRUFBeUMsbUJBQXpDLENBQWpCOztBQUNBLHlCQUFJLHNCQUFKLEVBQTRCNkQsUUFBNUI7QUFDQSxRQUFNaEIsa0JBQUdpQixNQUFILENBQVVmLGNBQUtDLE9BQUwsQ0FBYWhELFVBQWIsRUFBeUIsTUFBekIsRUFBaUMsSUFBakMsRUFBdUMsVUFBdkMsQ0FBVixDQUFOOztBQUdBLFFBQU0rRCxRQUFRLEdBQUc3RCxvQkFBVzhELE9BQVgsRUFBbUIsTUFBTW5CLGtCQUFHQyxRQUFILENBQVlDLGNBQUtDLE9BQUwsQ0FBYWhELFVBQWIsRUFBeUIsY0FBekIsRUFBeUMsYUFBekMsQ0FBWixFQUFxRSxNQUFyRSxDQUF6QixHQUF1RztBQUFDaUUsSUFBQUEsUUFBUSxFQUFFLElBQVg7QUFBaUJDLElBQUFBLE1BQU0sRUFBRTtBQUF6QixHQUF2RyxDQUFqQjs7QUFFQSxNQUFJQyxTQUFTLEdBQUcsQ0FBaEI7O0FBQ0EsT0FBSyxNQUFNQyxRQUFYLElBQXVCLE1BQU12QixrQkFBR3dCLElBQUgsQ0FBUVIsUUFBUixDQUE3QixFQUFnRDtBQUM5QyxVQUFNUyxnQkFBZ0IsR0FBR3ZCLGNBQUt3QixRQUFMLENBQWN4QixjQUFLQyxPQUFMLENBQWFoRCxVQUFiLEVBQXlCLGNBQXpCLENBQWQsRUFBd0RvRSxRQUF4RCxDQUF6Qjs7QUFDQSwyQkFBSyxtQkFBa0JBLFFBQVMsSUFBR0UsZ0JBQWlCLEVBQXBEO0FBR0EsVUFBTUUsUUFBUSxHQUFHLE1BQU0zQixrQkFBR0MsUUFBSCxDQUFZc0IsUUFBWixFQUFzQixNQUF0QixDQUF2Qjs7QUFDQSxVQUFNSyxTQUFTLEdBQUdDLGdCQUFLQyxJQUFMLENBQVVILFFBQVYsQ0FBbEI7O0FBQ0FDLElBQUFBLFNBQVMsQ0FBQ0csV0FBVixHQUF5QixJQUFHN0IsY0FBS3dCLFFBQUwsQ0FBY3ZFLFVBQWQsRUFBMEJvRSxRQUExQixDQUFvQyxFQUFoRTtBQUNBLFVBQU1TLGdCQUFnQixHQUFHLHVCQUFTSixTQUFULEVBQW9CSyxvQkFBcEIsQ0FBekI7O0FBQ0EsUUFBSUQsZ0JBQUosRUFBc0I7QUFDcEIsWUFBTSxJQUFJbEIsS0FBSixDQUFXLDZCQUE0QlMsUUFBUyxLQUFJVyxJQUFJLENBQUNDLFNBQUwsQ0FBZUgsZ0JBQWYsQ0FBaUMsRUFBckYsQ0FBTjtBQUNEOztBQUdELFVBQU1JLFFBQVEsR0FBR2xCLFFBQVEsQ0FBQ1UsU0FBRCxDQUF6QjtBQUdBLFVBQU1TLFlBQVksR0FBRyx5QkFBV1osZ0JBQVgsRUFBNkIsS0FBN0IsQ0FBckI7O0FBQ0EsVUFBTWEsT0FBTyxHQUFHcEMsY0FBS0MsT0FBTCxDQUFhaEQsVUFBYixFQUF5QixNQUF6QixFQUFpQyxJQUFqQyxFQUF1Q2tGLFlBQXZDLENBQWhCOztBQUNBLDJCQUFLLG1CQUFrQkMsT0FBUSxFQUEvQjtBQUNBLFVBQU0sMkJBQU9wQyxjQUFLcUMsT0FBTCxDQUFhRCxPQUFiLENBQVAsQ0FBTjtBQUNBLFVBQU10QyxrQkFBR3dDLFNBQUgsQ0FBYUYsT0FBYixFQUFzQkYsUUFBdEIsRUFBZ0MsTUFBaEMsQ0FBTjtBQUVBZCxJQUFBQSxTQUFTO0FBQ1Y7O0FBQ0QseUJBQUssZ0JBQWVBLFNBQVUsb0JBQTlCO0FBQ0Q7O0FBRUQsZUFBZW1CLG9CQUFmLEdBQXVDO0FBQ3JDLFdBQVNDLE9BQVQsQ0FBa0JDLE9BQWxCLEVBQTJCekMsSUFBM0IsRUFBaUM7QUFDL0IsUUFBSTBDLElBQUksR0FBRztBQUNUbkYsTUFBQUEsSUFBSSxFQUFFa0YsT0FBTyxDQUFDLENBQUQ7QUFESixLQUFYOztBQUdBLFFBQUksQ0FBQ2hGLGdCQUFFSSxPQUFGLENBQVU0RSxPQUFPLENBQUMsQ0FBRCxDQUFqQixDQUFMLEVBQTRCO0FBQzFCQyxNQUFBQSxJQUFJLENBQUMxQyxJQUFMLEdBQWEsR0FBRUEsSUFBSyxJQUFHeUMsT0FBTyxDQUFDLENBQUQsQ0FBSSxFQUFsQztBQUNELEtBRkQsTUFFTztBQUNMQyxNQUFBQSxJQUFJLENBQUMxQyxJQUFMLEdBQWEsR0FBRUEsSUFBSyxJQUFHeUMsT0FBTyxDQUFDLENBQUQsQ0FBUCxDQUFXLENBQVgsQ0FBYyxFQUFyQztBQUNBLFlBQU1sRixJQUFJLEdBQUdrRixPQUFPLENBQUMsQ0FBRCxDQUFQLENBQVdFLEtBQVgsRUFBYjtBQUNBRCxNQUFBQSxJQUFJLENBQUM1QixRQUFMLEdBQWdCLEVBQWhCOztBQUNBLFdBQUssSUFBSThCLFVBQVQsSUFBdUJILE9BQU8sQ0FBQyxDQUFELENBQTlCLEVBQW1DO0FBQ2pDQyxRQUFBQSxJQUFJLENBQUM1QixRQUFMLENBQWNwQixJQUFkLENBQW1COEMsT0FBTyxDQUFDSSxVQUFELEVBQWMsR0FBRTVDLElBQUssSUFBR3pDLElBQUssRUFBN0IsQ0FBMUI7QUFDRDtBQUNGOztBQUNELFdBQU9tRixJQUFQO0FBQ0Q7O0FBSUQsUUFBTUcsR0FBRyxHQUFHQyxPQUFPLENBQUM5QyxjQUFLQyxPQUFMLENBQWFoRCxVQUFiLEVBQXlCLE1BQXpCLEVBQWlDLFFBQWpDLENBQUQsQ0FBbkI7O0FBQ0EsUUFBTThGLFVBQVUsR0FBR3RGLGdCQUFFdUYsSUFBRixDQUFPSCxHQUFHLENBQUNJLEVBQVgsRUFBZ0IzRCxLQUFELElBQVdBLEtBQUssQ0FBQzRELE9BQU4sQ0FBYyxVQUFkLE1BQThCLENBQXhELENBQW5COztBQUNBLFFBQU1wQyxRQUFRLEdBQUcsRUFBakI7O0FBQ0EsT0FBSyxJQUFJcUMsRUFBVCxJQUFlSixVQUFVLENBQUMsQ0FBRCxDQUFWLENBQWNLLEtBQWQsQ0FBb0IsQ0FBcEIsQ0FBZixFQUF1QztBQUNyQ3RDLElBQUFBLFFBQVEsQ0FBQ3BCLElBQVQsQ0FBYzhDLE9BQU8sQ0FBQ1csRUFBRCxFQUFLLG1CQUFMLENBQXJCO0FBQ0Q7O0FBRUQsUUFBTUUsZUFBZSxHQUFHbEcsb0JBQVc4RCxPQUFYLEVBQW1CLE1BQU1uQixrQkFBR0MsUUFBSCxDQUFZQyxjQUFLQyxPQUFMLENBQWFoRCxVQUFiLEVBQXlCLGNBQXpCLEVBQXlDLGlCQUF6QyxDQUFaLEVBQXlFLE1BQXpFLENBQXpCLEdBQTJHO0FBQUNpRSxJQUFBQSxRQUFRLEVBQUUsSUFBWDtBQUFpQkMsSUFBQUEsTUFBTSxFQUFFO0FBQXpCLEdBQTNHLENBQXhCOztBQUVBLGlCQUFlbUMsVUFBZixDQUEyQjlDLEtBQTNCLEVBQWtDTSxRQUFsQyxFQUE0Q3lDLFNBQTVDLEVBQXVEO0FBQ3JELDJCQUFLLHVCQUFzQi9DLEtBQU0sR0FBakM7QUFDQSxVQUFNZ0QsZUFBZSxHQUFHSCxlQUFlLENBQUM7QUFDdEN2QyxNQUFBQSxRQURzQztBQUV0Q2QsTUFBQUEsSUFBSSxFQUFFdUQ7QUFGZ0MsS0FBRCxDQUF2QztBQUlBLFVBQU16RCxrQkFBR3dDLFNBQUgsQ0FBYTlCLEtBQWIsRUFBb0JnRCxlQUFwQixFQUFxQyxNQUFyQyxDQUFOO0FBQ0Q7O0FBRUQsUUFBTUMsUUFBUSxHQUFHekQsY0FBS0MsT0FBTCxDQUFhaEQsVUFBYixFQUF5QixNQUF6QixFQUFpQyxJQUFqQyxFQUF1QyxjQUF2QyxFQUF1RCxRQUF2RCxDQUFqQjs7QUFDQSxRQUFNcUcsVUFBVSxDQUFDRyxRQUFELEVBQVczQyxRQUFYLENBQWhCO0FBQ0EseUJBQUssNkJBQUw7O0FBRUEsaUJBQWU0QyxzQkFBZixDQUF1Q0MsT0FBdkMsRUFBZ0Q7QUFDOUMsUUFBSSxDQUFDQyxvQkFBS0MsUUFBTCxDQUFjRixPQUFPLENBQUM3QyxRQUF0QixDQUFMLEVBQXNDO0FBRXBDO0FBQ0Q7O0FBR0QsVUFBTWdELE9BQU8sR0FBR0gsT0FBTyxDQUFDM0QsSUFBUixDQUFhTyxVQUFiLENBQXdCUCxjQUFLK0QsR0FBN0IsSUFBb0NKLE9BQU8sQ0FBQzNELElBQVIsQ0FBYWdFLFNBQWIsQ0FBdUIsQ0FBdkIsQ0FBcEMsR0FBZ0VMLE9BQU8sQ0FBQzNELElBQXhGOztBQUNBLFVBQU1RLEtBQUssR0FBR1IsY0FBS0MsT0FBTCxDQUFhaEQsVUFBYixFQUF5QjZHLE9BQXpCLEVBQWtDLFdBQWxDLENBQWQ7O0FBQ0EsVUFBTVIsVUFBVSxDQUFDOUMsS0FBRCxFQUFRbUQsT0FBTyxDQUFDN0MsUUFBaEIsRUFBMEI2QyxPQUFPLENBQUMzRCxJQUFsQyxDQUFoQjs7QUFHQSxTQUFLLE1BQU1tRCxFQUFYLElBQWlCUSxPQUFPLENBQUM3QyxRQUF6QixFQUFtQztBQUNqQyxZQUFNNEMsc0JBQXNCLENBQUNQLEVBQUQsQ0FBNUI7QUFDRDtBQUNGOztBQUdELFFBQU0zQyxLQUFLLEdBQUdSLGNBQUtDLE9BQUwsQ0FBYWhELFVBQWIsRUFBeUIsTUFBekIsRUFBaUMsSUFBakMsRUFBdUMsVUFBdkMsRUFBbUQsV0FBbkQsQ0FBZDs7QUFDQSxRQUFNcUcsVUFBVSxDQUFDOUMsS0FBRCxFQUFRTSxRQUFSLENBQWhCOztBQUNBLE9BQUssTUFBTXFDLEVBQVgsSUFBaUJyQyxRQUFqQixFQUEyQjtBQUN6QixVQUFNNEMsc0JBQXNCLENBQUNQLEVBQUQsQ0FBNUI7QUFDRDtBQUNGOztBQUVELGVBQWVjLElBQWYsR0FBdUI7QUFDckIsUUFBTXBELGdCQUFnQixFQUF0QjtBQUNBLFFBQU0wQixvQkFBb0IsRUFBMUI7QUFDRDs7QUFFRCx3QkFBUzBCLElBQVQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB5YW1sIGZyb20gJ3lhbWwtanMnO1xuaW1wb3J0IHsgZnMsIG1rZGlycCwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB2YWxpZGF0ZSBmcm9tICd2YWxpZGF0ZS5qcyc7XG5pbXBvcnQgSGFuZGxlYmFycyBmcm9tICdoYW5kbGViYXJzJztcbmltcG9ydCByZXBsYWNlRXh0IGZyb20gJ3JlcGxhY2UtZXh0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBhc3luY2lmeSB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHZhbGlkYXRvciwgQ0xJRU5UX1VSTF9UWVBFUyB9IGZyb20gJy4vdmFsaWRhdG9yJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCBsb2cgZnJvbSAnZmFuY3ktbG9nJztcbmltcG9ydCBmaW5kUm9vdCBmcm9tICdmaW5kLXJvb3QnO1xuXG5cbi8vIFdoYXQgcmFuZ2Ugb2YgcGxhdGZvcm1zIGRvIHRoZSBkcml2ZXIncyBzdXBwb3J0XG5jb25zdCBwbGF0Zm9ybVJhbmdlcyA9IHtcbiAgeGN1aXRlc3Q6IFsnOS4zJ10sXG4gIHVpYXV0b21hdGlvbjogWyc4LjAnLCAnOS4zJ10sXG4gIGVzcHJlc3NvOiBbJz8nXSxcbiAgdWlhdXRvbWF0b3IyOiBbJz8nXSxcbiAgdWlhdXRvbWF0b3I6IFsnNC4yJ10sXG4gIHdpbmRvd3M6IFsnMTAnXSxcbiAgbWFjOiBbJz8nXSwgLy8gVE9ET1xufTtcblxuLy8gV2hlbiB3YXMgdGhlIGRyaXZlciBzdXBwb3J0ZWQgaW4gQXBwaXVtP1xuY29uc3QgYXBwaXVtUmFuZ2VzID0ge1xuICB4Y3VpdGVzdDogWycxLjYuMCddLFxuICB1aWF1dG9tYXRvcjI6IFsnMS42LjAnXSxcbiAgZXNwcmVzc286IFsnMS45LjAnXSxcbiAgd2luZG93czogWycxLjYuMCddLFxuICBtYWM6IFsnMS42LjQnXSxcbn07XG5cbmNvbnN0IHJvb3RGb2xkZXIgPSBmaW5kUm9vdChfX2Rpcm5hbWUpO1xuXG4vLyBDcmVhdGUgSGFuZGxlYmFycyBoZWxwZXIgdGhhdCBzaG93cyBhIHZlcnNpb24gcmFuZ2VcbkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3ZlcnNpb25zJywgZnVuY3Rpb24gdmVyc2lvbkhlbHBlciAob2JqZWN0LCBuYW1lLCBkcml2ZXJOYW1lKSB7XG4gIGlmICghb2JqZWN0KSB7XG4gICAgcmV0dXJuICdOb25lJztcbiAgfVxuXG4gIGlmICghXy5pc09iamVjdChvYmplY3QpKSB7XG4gICAgb2JqZWN0ID0ge307XG4gIH1cblxuICBsZXQgbWluID0gb2JqZWN0W25hbWUgPyBgJHtuYW1lfV9taW5gIDogJ21pbiddO1xuICBsZXQgbWF4ID0gb2JqZWN0W25hbWUgPyBgJHtuYW1lfV9tYXhgIDogJ21heCddO1xuXG4gIGlmICghbWluKSB7XG4gICAgaWYgKG5hbWUgPT09ICdhcHBpdW0nICYmIF8uaXNBcnJheShhcHBpdW1SYW5nZXNbZHJpdmVyTmFtZV0pKSB7XG4gICAgICBtaW4gPSBhcHBpdW1SYW5nZXNbZHJpdmVyTmFtZV1bMF07XG4gICAgfSBlbHNlIGlmIChuYW1lID09PSAncGxhdGZvcm0nICYmIF8uaXNBcnJheShwbGF0Zm9ybVJhbmdlc1tkcml2ZXJOYW1lXSkpIHtcbiAgICAgIG1pbiA9IHBsYXRmb3JtUmFuZ2VzW2RyaXZlck5hbWVdWzBdO1xuICAgIH1cbiAgfVxuXG4gIGlmICghbWF4KSB7XG4gICAgaWYgKG5hbWUgPT09ICdhcHBpdW0nICYmIGFwcGl1bVJhbmdlc1tkcml2ZXJOYW1lXSkge1xuICAgICAgbWF4ID0gYXBwaXVtUmFuZ2VzW2RyaXZlck5hbWVdWzFdO1xuICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ3BsYXRmb3JtJyAmJiBwbGF0Zm9ybVJhbmdlc1tkcml2ZXJOYW1lXSkge1xuICAgICAgbWF4ID0gcGxhdGZvcm1SYW5nZXNbZHJpdmVyTmFtZV1bMV07XG4gICAgfVxuICB9XG5cbiAgaWYgKCFtaW4gJiYgIW1heCkge1xuICAgIHJldHVybiAnQWxsJztcbiAgfSBlbHNlIGlmICghbWF4KSB7XG4gICAgcmV0dXJuIGAke21pbn0rYDtcbiAgfSBlbHNlIGlmICghbWluKSB7XG4gICAgcmV0dXJuIGA8PSAke21heH1gO1xuICB9XG5cbiAgcmV0dXJuIGAke21pbn0gdG8gJHttYXh9YDtcbn0pO1xuXG5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdoeXBoZW5hdGUnLCAoc3RyKSA9PiBzdHIucmVwbGFjZSgnXycsICctJykpO1xuSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndXBwZXJjYXNlJywgKHN0cikgPT4gc3RyLnRvVXBwZXJDYXNlKCkpO1xuXG5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdjYXBpdGFsaXplJywgZnVuY3Rpb24gY2FwaXRhbGl6ZURyaXZlciAoZHJpdmVyTmFtZSkge1xuICBzd2l0Y2ggKGRyaXZlck5hbWUudG9Mb3dlckNhc2UoKSkge1xuICAgIGNhc2UgJ3hjdWl0ZXN0JzpcbiAgICAgIHJldHVybiAnWENVSVRlc3QnO1xuICAgIGNhc2UgJ3VpYXV0b21hdGlvbic6XG4gICAgICByZXR1cm4gJ1VJQXV0b21hdGlvbic7XG4gICAgY2FzZSAndWlhdXRvbWF0b3IyJzpcbiAgICAgIHJldHVybiAnVWlBdXRvbWF0b3IyJztcbiAgICBjYXNlICd1aWF1dG9tYXRvcic6XG4gICAgICByZXR1cm4gJ1VpQXV0b21hdG9yJztcbiAgICBjYXNlICdlc3ByZXNzbyc6XG4gICAgICByZXR1cm4gJ0VzcHJlc3NvJztcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIGRyaXZlck5hbWUubGVuZ3RoID09PSAwID8gZHJpdmVyTmFtZSA6IGRyaXZlck5hbWVbMF0udG9VcHBlckNhc2UoKSArIGRyaXZlck5hbWUuc3Vic3RyKDEpO1xuICB9XG59KTtcblxuSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZfZXEnLCBmdW5jdGlvbiBpZkVxIChhLCBiLCBvcHRzKSB7XG4gIGlmIChhID09PSBiKSB7XG4gICAgcmV0dXJuIG9wdHMuZm4odGhpcyk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG9wdHMuaW52ZXJzZSh0aGlzKTtcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIGdldEJhc2VIb3N0bmFtZSAoZnVsbFVybCkge1xuICBjb25zdCBiYXNlVXJsID0gdXJsLnBhcnNlKGZ1bGxVcmwpO1xuICByZXR1cm4gYmFzZVVybC5ob3N0bmFtZTtcbn1cblxuSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmFzZV91cmwnLCBmdW5jdGlvbiBiYXNlVXJsIChmdWxsVXJsKSB7XG4gIHJldHVybiBnZXRCYXNlSG9zdG5hbWUoZnVsbFVybCk7XG59KTtcblxuSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignY2xpZW50X3VybCcsIGZ1bmN0aW9uIGNsaWVudFVybCAoY2xpZW50VXJsKSB7XG4gIGlmICghY2xpZW50VXJsKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgY3JlYXRlVXJsU3RyaW5nID0gZnVuY3Rpb24gY3JlYXRlVXJsU3RyaW5nIChjbGllbnRVcmwsIG5hbWUgPSBnZXRCYXNlSG9zdG5hbWUoY2xpZW50VXJsKSkge1xuICAgIHJldHVybiBgWyR7bmFtZX1dKCR7Y2xpZW50VXJsfSlgO1xuICB9O1xuXG4gIGlmICghXy5pc0FycmF5KGNsaWVudFVybCkpIHtcbiAgICByZXR1cm4gY3JlYXRlVXJsU3RyaW5nKGNsaWVudFVybCk7XG4gIH1cblxuICBsZXQgdXJsU3RyaW5ncyA9IFtdO1xuICBmb3IgKGNvbnN0IGl0ZW0gb2YgY2xpZW50VXJsKSB7XG4gICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIF8udG9QYWlycyhpdGVtKSkge1xuICAgICAga2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgICBjb25zdCB1cmxTdHIgPSBDTElFTlRfVVJMX1RZUEVTW2tleV0gPT09ICdob3N0bmFtZSdcbiAgICAgICAgPyBjcmVhdGVVcmxTdHJpbmcodmFsdWUpXG4gICAgICAgIDogY3JlYXRlVXJsU3RyaW5nKHZhbHVlLCBDTElFTlRfVVJMX1RZUEVTW2tleV0pO1xuICAgICAgdXJsU3RyaW5ncy5wdXNoKHVybFN0cik7XG4gICAgfVxuICB9XG4gIHJldHVybiB1cmxTdHJpbmdzLmpvaW4oJyAnKTtcbn0pO1xuXG5hc3luYyBmdW5jdGlvbiByZWdpc3RlclNwZWNVcmxIZWxwZXIgKCkge1xuICBjb25zdCByb3V0ZXNGaWxlID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdub2RlX21vZHVsZXMnLCAnYXBwaXVtLWJhc2UtZHJpdmVyJywgJ2xpYicsICdwcm90b2NvbCcsICdyb3V0ZXMuanMnKSwgJ3V0ZjgnKTtcbiAgY29uc3Qgcm91dGVzRmlsZUxpbmVzID0gcm91dGVzRmlsZS5zcGxpdCgnXFxuJyk7XG5cbiAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignc3BlY191cmwnLCBmdW5jdGlvbiBzcGVjVXJsIChzcGVjVXJsLCBlbmRwb2ludCkge1xuICAgIC8vIHJldHVybiB0aGUgdXJsIGlmIGl0IGlzIG5vdCBhIGxpbmsgdG8gb3VyIHJvdXRlcyBkb2NcbiAgICBpZiAoIXNwZWNVcmwuaW5jbHVkZXMoJ3JvdXRlcy5qcycpKSB7XG4gICAgICByZXR1cm4gc3BlY1VybDtcbiAgICB9XG4gICAgLy8gbWFrZSBzdXJlIGl0IGlzIGEgZnVsbCB1cmxcbiAgICBpZiAoc3BlY1VybC5zdGFydHNXaXRoKCdyb3V0ZXMuanMnKSkge1xuICAgICAgc3BlY1VybCA9IGBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS1iYXNlLWRyaXZlci9ibG9iL21hc3Rlci9saWIvcHJvdG9jb2wvJHtzcGVjVXJsfWA7XG4gICAgfVxuXG4gICAgLy8gc3RyaXAgb2ZmIGFueSBsaW5lIG51bWJlcnNcbiAgICBzcGVjVXJsID0gc3BlY1VybC5zcGxpdCgnI0wnKVswXTtcblxuICAgIC8vIHRoZSBlbmRwb2ludCBoZXJlIGlzIG9mdGVuIGBzZXNzaW9uX2lkYCBhbmQgd2UgbmVlZCBgc2Vzc2lvbklkYFxuICAgIGVuZHBvaW50ID0gZW5kcG9pbnQucmVwbGFjZSgnc2Vzc2lvbl9pZCcsICdzZXNzaW9uSWQnKTtcbiAgICAvLyBhbmQgYGVsZW1lbnRfaWRgIGFuZCB3ZSBuZWVkIGBlbGVtZW50SWRgXG4gICAgZW5kcG9pbnQgPSBlbmRwb2ludC5yZXBsYWNlKCdlbGVtZW50X2lkJywgJ2VsZW1lbnRJZCcpO1xuXG4gICAgLy8gZmluZCB0aGUgbGluZSBudW1iZXIgZm9yIHRoaXMgZW5kcG9pbnRcbiAgICBsZXQgaW5kZXg7XG4gICAgZm9yIChjb25zdCBpIGluIHJvdXRlc0ZpbGVMaW5lcykge1xuICAgICAgaWYgKHJvdXRlc0ZpbGVMaW5lc1tpXS5pbmNsdWRlcyhlbmRwb2ludCkpIHtcbiAgICAgICAgLy8gbGluZSBudW1iZXJzIGFyZSAxLWluZGV4ZWRcbiAgICAgICAgaW5kZXggPSBwYXJzZUludChpLCAxMCkgKyAxO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoaW5kZXgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIGVudHJ5IGluICdhcHBpdW0tYmFzZS1kcml2ZXIjcm91dGVzJyBmb3IgZW5kcG9pbnQgJyR7ZW5kcG9pbnR9J2ApO1xuICAgIH1cblxuICAgIHJldHVybiBgJHtzcGVjVXJsfSNMJHtpbmRleH1gO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVDb21tYW5kcyAoKSB7XG4gIGF3YWl0IHJlZ2lzdGVyU3BlY1VybEhlbHBlcigpO1xuXG4gIGNvbnN0IGNvbW1hbmRzID0gcGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdjb21tYW5kcy15bWwnLCAnY29tbWFuZHMvKiovKi55bWwnKTtcbiAgbG9nKCdUcmF2ZXJzaW5nIFlNTCBmaWxlcycsIGNvbW1hbmRzKTtcbiAgYXdhaXQgZnMucmltcmFmKHBhdGgucmVzb2x2ZShyb290Rm9sZGVyLCAnZG9jcycsICdlbicsICdjb21tYW5kcycpKTtcblxuICAvLyBnZXQgdGhlIHRlbXBsYXRlIGZyb20gd2hpY2ggdGhlIG1kIGZpbGVzIHdpbGwgYmUgY3JlYXRlZFxuICBjb25zdCB0ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuY29tcGlsZShhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUocm9vdEZvbGRlciwgJ2NvbW1hbmRzLXltbCcsICd0ZW1wbGF0ZS5tZCcpLCAndXRmOCcpLCB7bm9Fc2NhcGU6IHRydWUsIHN0cmljdDogdHJ1ZX0pO1xuXG4gIGxldCBmaWxlQ291bnQgPSAwO1xuICBmb3IgKGNvbnN0IGZpbGVuYW1lIG9mIGF3YWl0IGZzLmdsb2IoY29tbWFuZHMpKSB7XG4gICAgY29uc3QgcmVsYXRpdmVGaWxlbmFtZSA9IHBhdGgucmVsYXRpdmUocGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdjb21tYW5kcy15bWwnKSwgZmlsZW5hbWUpO1xuICAgIGxvZyhgUmVuZGVyaW5nIGZpbGU6ICR7ZmlsZW5hbWV9ICR7cmVsYXRpdmVGaWxlbmFtZX1gKTtcblxuICAgIC8vIFRyYW5zbGF0ZSB0aGUgWU1MIHNwZWNzIHRvIEpTT05cbiAgICBjb25zdCBpbnB1dFlNTCA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVuYW1lLCAndXRmOCcpO1xuICAgIGNvbnN0IGlucHV0SlNPTiA9IHlhbWwubG9hZChpbnB1dFlNTCk7XG4gICAgaW5wdXRKU09OLnltbEZpbGVOYW1lID0gYC8ke3BhdGgucmVsYXRpdmUocm9vdEZvbGRlciwgZmlsZW5hbWUpfWA7XG4gICAgY29uc3QgdmFsaWRhdGlvbkVycm9ycyA9IHZhbGlkYXRlKGlucHV0SlNPTiwgdmFsaWRhdG9yKTtcbiAgICBpZiAodmFsaWRhdGlvbkVycm9ycykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBEYXRhIHZhbGlkYXRpb24gZXJyb3IgZm9yICR7ZmlsZW5hbWV9OiAke0pTT04uc3RyaW5naWZ5KHZhbGlkYXRpb25FcnJvcnMpfWApO1xuICAgIH1cblxuICAgIC8vIFBhc3MgdGhlIGlucHV0SlMgaW50byBvdXIgSGFuZGxlYmFycyB0ZW1wbGF0ZVxuICAgIGNvbnN0IG1hcmtkb3duID0gdGVtcGxhdGUoaW5wdXRKU09OKTtcblxuICAgIC8vIFdyaXRlIHRoZSBtYXJrZG93biB0byBpdHMgcmlnaHQgcGxhY2VcbiAgICBjb25zdCBtYXJrZG93blBhdGggPSByZXBsYWNlRXh0KHJlbGF0aXZlRmlsZW5hbWUsICcubWQnKTtcbiAgICBjb25zdCBvdXRmaWxlID0gcGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdkb2NzJywgJ2VuJywgbWFya2Rvd25QYXRoKTtcbiAgICBsb2coYCAgICBXcml0aW5nIHRvOiAke291dGZpbGV9YCk7XG4gICAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShvdXRmaWxlKSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKG91dGZpbGUsIG1hcmtkb3duLCAndXRmOCcpO1xuXG4gICAgZmlsZUNvdW50Kys7XG4gIH1cbiAgbG9nKGBEb25lIHdyaXRpbmcgJHtmaWxlQ291bnR9IGNvbW1hbmQgZG9jdW1lbnRzYCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlQ29tbWFuZEluZGV4ICgpIHtcbiAgZnVuY3Rpb24gZ2V0VHJlZSAoZWxlbWVudCwgcGF0aCkge1xuICAgIGxldCBub2RlID0ge1xuICAgICAgbmFtZTogZWxlbWVudFswXSxcbiAgICB9O1xuICAgIGlmICghXy5pc0FycmF5KGVsZW1lbnRbMV0pKSB7XG4gICAgICBub2RlLnBhdGggPSBgJHtwYXRofS8ke2VsZW1lbnRbMV19YDtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9kZS5wYXRoID0gYCR7cGF0aH0vJHtlbGVtZW50WzFdWzBdfWA7XG4gICAgICBjb25zdCBuYW1lID0gZWxlbWVudFsxXS5zaGlmdCgpO1xuICAgICAgbm9kZS5jb21tYW5kcyA9IFtdO1xuICAgICAgZm9yIChsZXQgc3ViRWxlbWVudCBvZiBlbGVtZW50WzFdKSB7XG4gICAgICAgIG5vZGUuY29tbWFuZHMucHVzaChnZXRUcmVlKHN1YkVsZW1lbnQsIGAke3BhdGh9LyR7bmFtZX1gKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBub2RlO1xuICB9XG5cbiAgLy8gcGFyc2UgdGhlIHRvYy5qcyBmaWxlIGFuZCBnZXQgdGhlIGNvbW1hbmRzIGludG8gdGhlIGZvcm0gb2ZcbiAgLy8gICB7Y29tbWFuZHM6IFt7bmFtZTogJycsIHBhdGg6ICcnfSwge25hbWU6ICcnLCBjb21tYW5kczogWy4uLl19XX1cbiAgY29uc3QgdG9jID0gcmVxdWlyZShwYXRoLnJlc29sdmUocm9vdEZvbGRlciwgJ2RvY3MnLCAndG9jLmpzJykpO1xuICBjb25zdCBjb21tYW5kVG9jID0gXy5maW5kKHRvYy5lbiwgKHZhbHVlKSA9PiB2YWx1ZS5pbmRleE9mKCdDb21tYW5kcycpID09PSAwKTtcbiAgY29uc3QgY29tbWFuZHMgPSBbXTtcbiAgZm9yIChsZXQgZWwgb2YgY29tbWFuZFRvY1sxXS5zbGljZSgxKSkge1xuICAgIGNvbW1hbmRzLnB1c2goZ2V0VHJlZShlbCwgJy9kb2NzL2VuL2NvbW1hbmRzJykpO1xuICB9XG5cbiAgY29uc3QgY29tbWFuZFRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKGF3YWl0IGZzLnJlYWRGaWxlKHBhdGgucmVzb2x2ZShyb290Rm9sZGVyLCAnY29tbWFuZHMteW1sJywgJ2FwaS10ZW1wbGF0ZS5tZCcpLCAndXRmOCcpLCB7bm9Fc2NhcGU6IHRydWUsIHN0cmljdDogdHJ1ZX0pO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIHdyaXRlSW5kZXggKGluZGV4LCBjb21tYW5kcywgaW5kZXhQYXRoKSB7XG4gICAgbG9nKGBDcmVhdGluZyBBUEkgaW5kZXggJyR7aW5kZXh9J2ApO1xuICAgIGNvbnN0IGNvbW1hbmRNYXJrZG93biA9IGNvbW1hbmRUZW1wbGF0ZSh7XG4gICAgICBjb21tYW5kcyxcbiAgICAgIHBhdGg6IGluZGV4UGF0aCxcbiAgICB9KTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoaW5kZXgsIGNvbW1hbmRNYXJrZG93biwgJ3V0ZjgnKTtcbiAgfVxuXG4gIGNvbnN0IGFwaUluZGV4ID0gcGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdkb2NzJywgJ2VuJywgJ2Fib3V0LWFwcGl1bScsICdhcGkubWQnKTtcbiAgYXdhaXQgd3JpdGVJbmRleChhcGlJbmRleCwgY29tbWFuZHMpO1xuICBsb2coYERvbmUgd3JpdGluZyBtYWluIEFQSSBpbmRleGApO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIHdyaXRlSW5kaXZpZHVhbEluZGV4ZXMgKGNvbW1hbmQpIHtcbiAgICBpZiAoIXV0aWwuaGFzVmFsdWUoY29tbWFuZC5jb21tYW5kcykpIHtcbiAgICAgIC8vIHRoaXMgaXMgYSBsZWFmLCBzbyBlbmRcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB3cml0ZSB0aGlzIG5vZGVcbiAgICBjb25zdCByZWxQYXRoID0gY29tbWFuZC5wYXRoLnN0YXJ0c1dpdGgocGF0aC5zZXApID8gY29tbWFuZC5wYXRoLnN1YnN0cmluZygxKSA6IGNvbW1hbmQucGF0aDtcbiAgICBjb25zdCBpbmRleCA9IHBhdGgucmVzb2x2ZShyb290Rm9sZGVyLCByZWxQYXRoLCAnUkVBRE1FLm1kJyk7XG4gICAgYXdhaXQgd3JpdGVJbmRleChpbmRleCwgY29tbWFuZC5jb21tYW5kcywgY29tbWFuZC5wYXRoKTtcblxuICAgIC8vIGdvIHRocm91Z2ggYWxsIHRoZSBzdWItY29tbWFuZHNcbiAgICBmb3IgKGNvbnN0IGVsIG9mIGNvbW1hbmQuY29tbWFuZHMpIHtcbiAgICAgIGF3YWl0IHdyaXRlSW5kaXZpZHVhbEluZGV4ZXMoZWwpO1xuICAgIH1cbiAgfVxuXG4gIC8vIGdvIHRocm91Z2ggdGhlIGZ1bGwgdHJlZSBhbmQgZ2VuZXJhdGUgcmVhZG1lIGZpbGVzXG4gIGNvbnN0IGluZGV4ID0gcGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdkb2NzJywgJ2VuJywgJ2NvbW1hbmRzJywgJ1JFQURNRS5tZCcpO1xuICBhd2FpdCB3cml0ZUluZGV4KGluZGV4LCBjb21tYW5kcyk7XG4gIGZvciAoY29uc3QgZWwgb2YgY29tbWFuZHMpIHtcbiAgICBhd2FpdCB3cml0ZUluZGl2aWR1YWxJbmRleGVzKGVsKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBtYWluICgpIHtcbiAgYXdhaXQgZ2VuZXJhdGVDb21tYW5kcygpO1xuICBhd2FpdCBnZW5lcmF0ZUNvbW1hbmRJbmRleCgpO1xufVxuXG5hc3luY2lmeShtYWluKTtcbiJdLCJmaWxlIjoiY29tbWFuZHMteW1sL3BhcnNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
